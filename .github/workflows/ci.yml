name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  lint:
    name: Lint and Format Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        run: npm run format:check
        continue-on-error: false

      - name: Run ESLint (JS + HTML)
        run: npm run lint
        continue-on-error: false

      - name: Run Stylelint (CSS)
        run: npm run lint:css
        continue-on-error: false

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [lint]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v1.3.0/k6-v1.3.0-linux-amd64.tar.gz | tar xvz --strip-components=1 -C /tmp
          sudo mv /tmp/k6 /usr/local/bin/k6
          k6 version

      - name: Run unit tests
        run: npm test -- --coverage

      - name: Run k6 performance tests
        run: npm run test:k6

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload k6 reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: k6-reports
          path: tests/k6/reports/
          retention-days: 30

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v1.3.0/k6-v1.3.0-linux-amd64.tar.gz | tar xvz --strip-components=1 -C /tmp
          sudo mv /tmp/k6 /usr/local/bin/k6
          k6 version

      - name: Generate Jest test reports
        run: |
          mkdir -p tests/jest/reports
          npm test -- --coverage --json --outputFile=tests/jest/reports/results-latest.json || echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json
          # Verify file has valid JSON
          if [ ! -s tests/jest/reports/results-latest.json ]; then
            echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json
          fi
          echo "Jest reports generated"

      - name: Generate K6 performance reports
        run: |
          cd tests/k6
          chmod +x run-tests.sh
          ./run-tests.sh || true
          cd ../..
          echo "K6 reports generated"

      - name: List generated reports
        run: |
          echo "=== Jest Reports ==="
          ls -lah tests/jest/reports/ || echo "No Jest reports"
          if [ -f tests/jest/reports/results-latest.json ]; then
            echo "Jest results file size:"
            wc -c tests/jest/reports/results-latest.json
            echo "First 200 chars:"
            head -c 200 tests/jest/reports/results-latest.json
            echo ""
            echo "Validating JSON:"
            if jq empty tests/jest/reports/results-latest.json 2>/dev/null; then
              echo "✓ Valid JSON"
            else
              echo "✗ Invalid JSON - Creating fallback"
              echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json
            fi
          fi
          echo ""
          echo "=== K6 Reports ==="
          ls -lah tests/k6/reports/ || echo "No K6 reports"
          if [ -f tests/k6/reports/http-summary-*.json ]; then
            echo "K6 summary exists"
          fi

      - name: Prepare deployment directory
        run: |
          # Create a clean deployment directory
          mkdir -p deploy_temp
          
          # Copy all necessary files (excluding development artifacts)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='.github' --exclude='deploy_temp' --exclude='coverage' ./ deploy_temp/
          
          # Explicitly copy test reports (they are gitignored but needed for GitHub Pages)
          mkdir -p deploy_temp/tests/jest/reports
          mkdir -p deploy_temp/tests/k6/reports
          
          # Copy Jest reports
          if [ -f tests/jest/reports/results-latest.json ]; then
            cp -v tests/jest/reports/results-latest.json deploy_temp/tests/jest/reports/
            echo "✓ Copied Jest results"
          else
            echo "⚠ No Jest results found, creating placeholder"
            echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > deploy_temp/tests/jest/reports/results-latest.json
          fi
          
          # Copy K6 reports
          cp -v tests/k6/reports/*.json deploy_temp/tests/k6/reports/ 2>/dev/null || echo "⚠ No K6 JSON reports to copy"
          
          # Ensure .gitignore will not exclude any report files in the publish tree
          if [ -f deploy_temp/.gitignore ]; then
            sed -i '/^tests\/jest\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/k6\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/puppeteer\/reports\/\*/d' deploy_temp/.gitignore || true
            # As a safety net, remove .gitignore entirely from the publish dir
            rm -f deploy_temp/.gitignore
          fi
          
          # Verify test reports are included
          echo ""
          echo "=== Verifying deploy_temp contents ==="
          ls -lah deploy_temp/tests/jest/reports/ || echo "No Jest reports in deploy_temp"
          echo ""
          ls -lah deploy_temp/tests/k6/reports/ || echo "No K6 reports in deploy_temp"
          echo ""
          echo "=== Verifying Jest JSON is valid ==="
          if jq empty deploy_temp/tests/jest/reports/results-latest.json 2>/dev/null; then
            echo "✓ Jest JSON is valid"
            jq -r '.numTotalTests // 0' deploy_temp/tests/jest/reports/results-latest.json | xargs -I {} echo "Total tests: {}"
          else
            echo "✗ Jest JSON is invalid"
          fi

      - name: Generate slim Jest summary + extra variants
        run: |
          echo "Generating slim Jest summary JSON"
          SUMMARY_SOURCE="deploy_temp/tests/jest/reports/results-latest.json"
          if [ ! -f "$SUMMARY_SOURCE" ]; then
            echo "Source not found, trying original tests path"
            SUMMARY_SOURCE="tests/jest/reports/results-latest.json"
          fi
          if [ ! -f "$SUMMARY_SOURCE" ]; then
            echo "No Jest results file to summarize. Creating fallback summary."
            mkdir -p deploy_temp/tests/jest/reports
            printf '%s' "{\"success\":false,\"numTotalTests\":0,\"numPassedTests\":0,\"numFailedTests\":0,\"numTotalTestSuites\":0,\"generatedAt\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > deploy_temp/tests/jest/reports/results-summary.json
          else
            TOTAL=$(jq -r '.numTotalTests // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            PASSED=$(jq -r '.numPassedTests // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            FAILED=$(jq -r '.numFailedTests // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            SUITES=$(jq -r '.numTotalTestSuites // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            PASSED_SUITES=$(jq -r '.numPassedTestSuites // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo $SUITES)
            SUCCESS=$([ "$FAILED" -eq 0 ] && echo true || echo false)
            PASS_RATE=0
            if [ "$TOTAL" -gt 0 ]; then
              PASS_RATE=$(awk -v p="$PASSED" -v t="$TOTAL" 'BEGIN { printf "%.2f", (p/t)*100 }')
            fi
            GENERATED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            # Write summary inside original reports dir
            echo "Writing deploy_temp/tests/jest/reports/results-summary.json"
            printf '%s' "{\"success\":$SUCCESS,\"numTotalTests\":$TOTAL,\"numPassedTests\":$PASSED,\"numFailedTests\":$FAILED,\"numTotalTestSuites\":$SUITES,\"numPassedTestSuites\":$PASSED_SUITES,\"passRate\":$PASS_RATE,\"generatedAt\":\"$GENERATED_AT\"}" > deploy_temp/tests/jest/reports/results-summary.json
            # Also provide copy in top-level reports directory for simpler path
            mkdir -p deploy_temp/reports
            cp deploy_temp/tests/jest/reports/results-summary.json deploy_temp/reports/jest-summary.json
            # Provide a renamed full copy for debugging (some large JSON may be blocked by Pages). This helps verify alternate filename behavior.
            cp "$SUMMARY_SOURCE" deploy_temp/tests/jest/reports/results-full.json || true
            echo "Summary + full copy generated. Sizes:"
            wc -c deploy_temp/tests/jest/reports/results-summary.json || true
            wc -c "$SUMMARY_SOURCE" || true
          fi
          echo "Listing Jest report variants:"
          ls -lah deploy_temp/tests/jest/reports/ | grep -E 'results-(summary|latest|full)\.json' || true
          ls -lah deploy_temp/reports/ | grep -E 'jest-summary\.json' || true
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy_temp
          publish_branch: gh-pages
          force_orphan: true
