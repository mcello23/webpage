name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  lint:
    name: Lint and Format Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        run: npm run format:check
        continue-on-error: false

      - name: Run ESLint (JS + HTML)
        run: npm run lint
        continue-on-error: false

      - name: Run Stylelint (CSS)
        run: npm run lint:css
        continue-on-error: false

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [lint]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v1.3.0/k6-v1.3.0-linux-amd64.tar.gz | tar xvz --strip-components=1 -C /tmp
          sudo mv /tmp/k6 /usr/local/bin/k6
          k6 version

      - name: Run unit tests
        run: npm test -- --coverage

      - name: Run k6 performance tests
        run: npm run test:k6

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload k6 reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: k6-reports
          path: tests/k6/reports/
          retention-days: 30

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v1.3.0/k6-v1.3.0-linux-amd64.tar.gz | tar xvz --strip-components=1 -C /tmp
          sudo mv /tmp/k6 /usr/local/bin/k6
          k6 version

      - name: Generate Jest test reports
        run: |
          mkdir -p tests/jest/reports
          npm test -- --coverage --json --outputFile=tests/jest/reports/results-latest.json || echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json
          # Verify file has valid JSON
          if [ ! -s tests/jest/reports/results-latest.json ]; then
            echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json
          fi
          echo "Jest reports generated"

      - name: Generate K6 performance reports
        run: |
          cd tests/k6
          chmod +x run-tests.sh
          ./run-tests.sh || true
          cd ../..
          echo "K6 reports generated"

      - name: List generated reports
        run: |
          echo "=== Jest Reports ==="
          ls -lah tests/jest/reports/ || echo "No Jest reports"
          if [ -f tests/jest/reports/results-latest.json ]; then
            echo "Jest results file size:"
            wc -c tests/jest/reports/results-latest.json
            echo "First 200 chars:"
            head -c 200 tests/jest/reports/results-latest.json
            echo ""
            echo "Validating JSON:"
            if jq empty tests/jest/reports/results-latest.json 2>/dev/null; then
              echo "‚úì Valid JSON"
            else
              echo "‚úó Invalid JSON - Creating fallback"
              echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json
            fi
          fi
          echo ""
          echo "=== K6 Reports ==="
          ls -lah tests/k6/reports/ || echo "No K6 reports"
          if [ -f tests/k6/reports/http-summary-*.json ]; then
            echo "K6 summary exists"
          fi

      - name: Prepare deployment directory
        run: |
          # Create a clean deployment directory
          mkdir -p deploy_temp
          
          # Copy all necessary files (excluding development artifacts)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='.github' --exclude='deploy_temp' --exclude='coverage' ./ deploy_temp/
          
          # Ensure .nojekyll exists (critical for GitHub Pages to serve all files)
          touch deploy_temp/.nojekyll
          
          # Create empty _config.yml to prevent Jekyll processing
          echo "" > deploy_temp/_config.yml
          
          # Explicitly copy test reports (they are gitignored but needed for GitHub Pages)
          mkdir -p deploy_temp/tests/jest/reports
          mkdir -p deploy_temp/tests/k6/reports
          
          # Copy Jest reports
          if [ -f tests/jest/reports/results-latest.json ]; then
            cp -v tests/jest/reports/results-latest.json deploy_temp/tests/jest/reports/
            echo "‚úì Copied Jest results"
          else
            echo "‚ö† No Jest results found, creating placeholder"
            echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > deploy_temp/tests/jest/reports/results-latest.json
          fi
          
          # Copy K6 reports
          cp -v tests/k6/reports/*.json deploy_temp/tests/k6/reports/ 2>/dev/null || echo "‚ö† No K6 JSON reports to copy"
          
          # Ensure .gitignore will not exclude any report files in the publish tree
          if [ -f deploy_temp/.gitignore ]; then
            sed -i '/^tests\/jest\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/k6\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/puppeteer\/reports\/\*/d' deploy_temp/.gitignore || true
            # As a safety net, remove .gitignore entirely from the publish dir
            rm -f deploy_temp/.gitignore
          fi
          
          # Verify test reports are included
          echo ""
          echo "=== Verifying deploy_temp contents ==="
          ls -lah deploy_temp/tests/jest/reports/ || echo "No Jest reports in deploy_temp"
          echo ""
          ls -lah deploy_temp/tests/k6/reports/ || echo "No K6 reports in deploy_temp"
          echo ""
          echo "=== Verifying Jest JSON is valid ==="
          if jq empty deploy_temp/tests/jest/reports/results-latest.json 2>/dev/null; then
            echo "‚úì Jest JSON is valid"
            jq -r '.numTotalTests // 0' deploy_temp/tests/jest/reports/results-latest.json | xargs -I {} echo "Total tests: {}"
          else
            echo "‚úó Jest JSON is invalid"
          fi

      - name: Generate test data as JavaScript module
        run: |
          echo "Generating test data as JavaScript (GitHub Pages blocks JSON in subdirs)"
          SUMMARY_SOURCE="deploy_temp/tests/jest/reports/results-latest.json"
          if [ ! -f "$SUMMARY_SOURCE" ]; then
            echo "Source not found, trying original tests path"
            SUMMARY_SOURCE="tests/jest/reports/results-latest.json"
          fi
          
          # Extract Jest data
          if [ ! -f "$SUMMARY_SOURCE" ]; then
            echo "No Jest results. Creating fallback."
            JEST_DATA='{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0,"generatedAt":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}'
          else
            TOTAL=$(jq -r '.numTotalTests // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            PASSED=$(jq -r '.numPassedTests // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            FAILED=$(jq -r '.numFailedTests // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            SUITES=$(jq -r '.numTotalTestSuites // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo 0)
            PASSED_SUITES=$(jq -r '.numPassedTestSuites // 0' "$SUMMARY_SOURCE" 2>/dev/null || echo $SUITES)
            SUCCESS=$([ "$FAILED" -eq 0 ] && echo true || echo false)
            PASS_RATE=0
            if [ "$TOTAL" -gt 0 ]; then
              PASS_RATE=$(awk -v p="$PASSED" -v t="$TOTAL" 'BEGIN { printf "%.2f", (p/t)*100 }')
            fi
            GENERATED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            JEST_DATA='{"success":'$SUCCESS',"numTotalTests":'$TOTAL',"numPassedTests":'$PASSED',"numFailedTests":'$FAILED',"numTotalTestSuites":'$SUITES',"numPassedTestSuites":'$PASSED_SUITES',"passRate":'$PASS_RATE',"generatedAt":"'$GENERATED_AT'"}'
          fi
          
          # Extract K6 data
          K6_FILE="deploy_temp/tests/k6/reports/http-summary-latest.json"
          if [ ! -f "$K6_FILE" ]; then
            K6_FILE="tests/k6/reports/http-summary-latest.json"
          fi
          if [ -f "$K6_FILE" ]; then
            K6_DATA=$(cat "$K6_FILE")
          else
            K6_DATA='{"metrics":{"http_reqs":{"count":0},"http_req_duration":{"avg":0,"p(95)":0},"checks":{"passes":0,"fails":0}}}'
          fi
          
          # Create JavaScript module as .txt file (GitHub Pages can't block .txt)
          echo "// Auto-generated test results data" > deploy_temp/test-data.txt
          echo "// Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> deploy_temp/test-data.txt
          echo "if (typeof window !== 'undefined') {" >> deploy_temp/test-data.txt
          echo "  window.TEST_RESULTS = {" >> deploy_temp/test-data.txt
          echo "    jest: $JEST_DATA," >> deploy_temp/test-data.txt
          echo "    k6: $K6_DATA," >> deploy_temp/test-data.txt
          echo "    generatedAt: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> deploy_temp/test-data.txt
          echo "  };" >> deploy_temp/test-data.txt
          echo "}" >> deploy_temp/test-data.txt
          
          echo "‚úì Generated deploy_temp/test-data.txt (as .txt to bypass restrictions)"
          echo "File size:"
          wc -c deploy_temp/test-data.txt
          echo "First 300 chars:"
          head -c 300 deploy_temp/test-data.txt
          echo ""
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy_temp
          publish_branch: gh-pages
          force_orphan: true
          cname: false
          
      - name: Trigger Pages rebuild
        run: |
          echo "Waiting for Pages to process deployment..."
          sleep 5
          echo "‚úì Deployment complete. GitHub Pages may take 1-2 minutes to serve updated files."
          echo "üìä Test dashboard available at: https://mcello23.github.io/webpage/"
          echo ""
          echo "üîç Direct file URLs (for debugging):"
          echo "   - https://mcello23.github.io/webpage/reports/jest-summary.json"
          echo "   - https://mcello23.github.io/webpage/tests/jest/reports/results-summary.json"
          echo ""
          echo "üí° If files return 404, wait 2-5 minutes for CDN propagation or try:"
          echo "   curl -I https://mcello23.github.io/webpage/reports/jest-summary.json"
          
      - name: Verify deployment files via GitHub API
        run: |
          echo "Verifying files are in gh-pages branch..."
          sleep 10
          # Check via GitHub API if files exist
          for path in "reports/jest-summary.json" "tests/jest/reports/results-summary.json" "tests/k6/reports/http-summary-latest.json"; do
            echo "Checking: $path"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://raw.githubusercontent.com/${{ github.repository }}/gh-pages/$path")
            if [ "$STATUS" = "200" ]; then
              echo "  ‚úì $path exists in gh-pages (HTTP $STATUS)"
            else
              echo "  ‚úó $path missing in gh-pages (HTTP $STATUS)"
            fi
          done
          echo ""
          echo "‚è≥ Note: GitHub Pages CDN may take 1-10 minutes to serve these files at mcello23.github.io"
