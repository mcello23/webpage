name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  lint:
    name: Lint and Format Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        run: npm run format:check
        continue-on-error: false

      - name: Run ESLint (JS + HTML)
        run: npm run lint
        continue-on-error: false

      - name: Run Stylelint (CSS)
        run: npm run lint:css
        continue-on-error: false

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [lint]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run unit tests with coverage
        run: |
          mkdir -p tests/jest/reports
          npm test -- --coverage --json --outputFile=tests/jest/reports/results-latest.json || echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json

      - name: Run k6 performance tests
        run: |
          cd tests/k6
          chmod +x run-tests.sh
          ./run-tests.sh || true

      - name: Upload Jest reports as artifact
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: jest-reports
          path: tests/jest/reports/
          retention-days: 30

      - name: Upload k6 reports as artifact
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: k6-reports
          path: tests/k6/reports/
          retention-days: 30

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js (for jq processing only)
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'

      - name: Download Jest reports from test job
        uses: actions/download-artifact@v5
        with:
          name: jest-reports
          path: tests/jest/reports/

      - name: Download K6 reports from test job
        uses: actions/download-artifact@v5
        with:
          name: k6-reports
          path: tests/k6/reports/

      - name: Verify downloaded reports
        run: |
          echo "=== Downloaded Jest Reports ==="
          ls -lah tests/jest/reports/ || echo "No Jest reports"
          if [ -f tests/jest/reports/results-latest.json ]; then
            echo "‚úì Jest results downloaded"
            wc -c tests/jest/reports/results-latest.json
          fi
          echo ""
          echo "=== Downloaded K6 Reports ==="
          ls -lah tests/k6/reports/ || echo "No K6 reports"
          if [ -f tests/k6/reports/http-summary-latest.json ]; then
            echo "‚úì K6 results downloaded"
            wc -c tests/k6/reports/http-summary-latest.json
          fi

      - name: Prepare deployment directory
        run: |
          # Create a clean deployment directory
          mkdir -p deploy_temp
          
          # Copy all necessary files (excluding development artifacts)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='.github' --exclude='deploy_temp' --exclude='coverage' ./ deploy_temp/
          
          # Ensure .nojekyll exists (critical for GitHub Pages to serve all files)
          touch deploy_temp/.nojekyll
          
          # Create empty _config.yml to prevent Jekyll processing
          echo "" > deploy_temp/_config.yml
          
          # Explicitly copy test reports (they are gitignored but needed for GitHub Pages)
          mkdir -p deploy_temp/tests/jest/reports
          mkdir -p deploy_temp/tests/k6/reports
          
          # Copy Jest reports
          if [ -f tests/jest/reports/results-latest.json ]; then
            cp -v tests/jest/reports/results-latest.json deploy_temp/tests/jest/reports/
            echo "‚úì Copied Jest results"
          else
            echo "‚ö† No Jest results found, creating placeholder"
            echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > deploy_temp/tests/jest/reports/results-latest.json
          fi
          
          # Copy K6 reports
          cp -v tests/k6/reports/*.json deploy_temp/tests/k6/reports/ 2>/dev/null || echo "‚ö† No K6 JSON reports to copy"
          
          # Ensure .gitignore will not exclude any report files in the publish tree
          if [ -f deploy_temp/.gitignore ]; then
            sed -i '/^tests\/jest\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/k6\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/puppeteer\/reports\/\*/d' deploy_temp/.gitignore || true
            # As a safety net, remove .gitignore entirely from the publish dir
            rm -f deploy_temp/.gitignore
          fi
          
          # Verify test reports are included
          echo ""
          echo "=== Verifying deploy_temp contents ==="
          ls -lah deploy_temp/tests/jest/reports/ || echo "No Jest reports in deploy_temp"
          echo ""
          ls -lah deploy_temp/tests/k6/reports/ || echo "No K6 reports in deploy_temp"
          echo ""
          echo "=== Verifying Jest JSON is valid ==="
          if jq empty deploy_temp/tests/jest/reports/results-latest.json 2>/dev/null; then
            echo "‚úì Jest JSON is valid"
            jq -r '.numTotalTests // 0' deploy_temp/tests/jest/reports/results-latest.json | xargs -I {} echo "Total tests: {}"
          else
            echo "‚úó Jest JSON is invalid"
          fi

      - name: Generate test-data.txt for the dashboard
        run: |
          mkdir -p deploy_temp
          # Jest
          JEST_SRC="tests/jest/reports/results-latest.json"
          if [ -f "deploy_temp/tests/jest/reports/results-latest.json" ]; then
            JEST_SRC="deploy_temp/tests/jest/reports/results-latest.json"
          fi
          if [ -f "$JEST_SRC" ]; then
            TOTAL=$(jq -r '.numTotalTests // 0' "$JEST_SRC")
            PASSED=$(jq -r '.numPassedTests // 0' "$JEST_SRC")
            FAILED=$(jq -r '.numFailedTests // 0' "$JEST_SRC")
            SUITES=$(jq -r '.numTotalTestSuites // 0' "$JEST_SRC")
            PASSED_SUITES=$(jq -r '.numPassedTestSuites // 0' "$JEST_SRC")
            SUCCESS=$([ "$FAILED" -eq 0 ] && echo true || echo false)
            if [ "$TOTAL" -gt 0 ]; then
              PASS_RATE=$(awk -v p="$PASSED" -v t="$TOTAL" 'BEGIN { printf "%.2f", (p/t)*100 }')
            else
              PASS_RATE="100.00"
            fi
            JEST_JSON="{\"success\":$SUCCESS,\"numTotalTests\":$TOTAL,\"numPassedTests\":$PASSED,\"numFailedTests\":$FAILED,\"numTotalTestSuites\":$SUITES,\"numPassedTestSuites\":$PASSED_SUITES,\"passRate\":$PASS_RATE}"
          else
            JEST_JSON='{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0,"passRate":0}'
          fi

          # k6
          K6_SRC="deploy_temp/tests/k6/reports/http-summary-latest.json"
          [ ! -f "$K6_SRC" ] && K6_SRC="tests/k6/reports/http-summary-latest.json"
          if [ -f "$K6_SRC" ]; then
            K6_JSON=$(cat "$K6_SRC")
          else
            K6_JSON='{"metrics":{"http_reqs":{"count":0},"http_req_duration":{"avg":0,"p(95)":0},"checks":{"passes":0,"fails":0}}}'
          fi

          # Emit the payload the dashboard loads (as .txt so Pages serves it)
          cat > deploy_temp/test-data.txt <<'EOF'
          // Auto-generated test results data
          if (typeof window !== 'undefined') {
            window.TEST_RESULTS = {};
          }
          EOF
          # Append JSON safely
          {
            echo "window.TEST_RESULTS.jest = $JEST_JSON;"
            echo "window.TEST_RESULTS.k6 = $K6_JSON;"
            echo "window.TEST_RESULTS.generatedAt = '$(date -u +%Y-%m-%dT%H:%M:%SZ)';"
          } >> deploy_temp/test-data.txt

          echo "‚úì Emitted deploy_temp/test-data.txt"
          echo "File size:"
          wc -c deploy_temp/test-data.txt
          echo "First 400 chars:"
          head -c 400 deploy_temp/test-data.txt
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy_temp
          publish_branch: gh-pages
          force_orphan: true
          cname: false
          
      - name: Trigger Pages rebuild
        run: |
          echo "Waiting for Pages to process deployment..."
          sleep 5
          echo "‚úì Deployment complete. GitHub Pages may take 1-2 minutes to serve updated files."
          echo "üìä Test dashboard available at: https://mcello23.github.io/webpage/"
          echo ""
          echo "üîç Test data file:"
          echo "   - https://mcello23.github.io/webpage/test-data.txt"
          echo ""
          echo "üí° If file returns 404, wait 2-5 minutes for CDN propagation"
          
      - name: Verify test-data.txt deployment
        run: |
          echo "Verifying test-data.txt is in gh-pages branch..."
          sleep 10
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://raw.githubusercontent.com/${{ github.repository }}/gh-pages/test-data.txt")
          if [ "$STATUS" = "200" ]; then
            echo "‚úì test-data.txt found in gh-pages branch"
            curl -s "https://raw.githubusercontent.com/${{ github.repository }}/gh-pages/test-data.txt" | head -c 300
            echo ""
          else
            echo "‚ö† test-data.txt returned HTTP $STATUS (may need CDN propagation time)"
          fi
          echo ""
          echo "‚è≥ Note: GitHub Pages CDN may take 1-10 minutes to serve at mcello23.github.io"
