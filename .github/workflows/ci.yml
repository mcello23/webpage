name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  lint:
    name: Lint and Format Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'

      - name: Enable Corepack
        run: corepack enable

      - name: Set Puppeteer environment variables
        run: |
          echo "PUPPETEER_CACHE_DIR=$HOME/.cache/puppeteer" >> $GITHUB_ENV
          echo "PUPPETEER_SKIP_DOWNLOAD=false" >> $GITHUB_ENV

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies and built packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            ~/.cache/puppeteer
            node_modules
          key: ${{ runner.os }}-yarn-v2-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-yarn-v2-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-yarn-v2-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run Prettier check
        run: yarn format:check
        continue-on-error: false

      - name: Run ESLint (JS + HTML)
        run: yarn lint
        continue-on-error: false

      - name: Run Stylelint (CSS)
        run: yarn lint:css
        continue-on-error: false

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [lint]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'

      - name: Enable Corepack
        run: corepack enable

      - name: Set Puppeteer environment variables
        run: |
          echo "PUPPETEER_CACHE_DIR=$HOME/.cache/puppeteer" >> $GITHUB_ENV
          echo "PUPPETEER_SKIP_DOWNLOAD=false" >> $GITHUB_ENV

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies and built packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            ~/.cache/puppeteer
            node_modules
          key: ${{ runner.os }}-yarn-v2-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-yarn-v2-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-yarn-v2-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run all tests with coverage
        run: |
          mkdir -p tests/jest/reports
          yarn test:all --json --outputFile=tests/jest/reports/results-latest.json || echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > tests/jest/reports/results-latest.json

      - name: Run k6 performance tests
        run: |
          chmod +x tests/k6/run-tests.sh
          ./tests/k6/run-tests.sh || true

      - name: Upload Jest reports as artifact
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: jest-reports
          path: tests/jest/reports/
          retention-days: 30

      - name: Upload k6 reports as artifact
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: k6-reports
          path: tests/k6/reports/
          retention-days: 30

      # Restore coverage artifact upload
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  deploy:
    name: Archive Test Reports
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js (for jq processing only)
        uses: actions/setup-node@v6
        with:
          node-version: '22.20.0'

      - name: Download Jest reports from test job
        uses: actions/download-artifact@v5
        with:
          name: jest-reports
          path: tests/jest/reports/

      - name: Download K6 reports from test job
        uses: actions/download-artifact@v5
        with:
          name: k6-reports
          path: tests/k6/reports/

      - name: Download coverage reports from test job
        uses: actions/download-artifact@v5
        with:
          name: coverage-report
          path: coverage/

      - name: Verify downloaded reports
        run: |
          echo "=== Downloaded Jest Reports ==="
          ls -lah tests/jest/reports/ || echo "No Jest reports"
          if [ -f tests/jest/reports/results-latest.json ]; then
            echo "âœ“ Jest results downloaded"
            wc -c tests/jest/reports/results-latest.json
          fi
          echo ""
          echo "=== Downloaded K6 Reports ==="
          ls -lah tests/k6/reports/ || echo "No K6 reports"
          if [ -f tests/k6/reports/http-summary-latest.json ]; then
            echo "âœ“ K6 results downloaded"
            wc -c tests/k6/reports/http-summary-latest.json
          fi
          echo ""
          echo "=== Downloaded Coverage Reports ==="
          ls -lah coverage/ || echo "No coverage reports"
          if [ -f coverage/coverage-summary.json ]; then
            echo "âœ“ Coverage summary downloaded"
            wc -c coverage/coverage-summary.json
          fi

      - name: Prepare deployment directory
        run: |
          # Create a clean deployment directory
          mkdir -p deploy_temp

          # Copy all necessary files (excluding development artifacts)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='.github' --exclude='deploy_temp' ./ deploy_temp/

          # Ensure .nojekyll exists (critical for GitHub Pages to serve all files)
          touch deploy_temp/.nojekyll

          # Create empty _config.yml to prevent Jekyll processing
          echo "" > deploy_temp/_config.yml

          # Explicitly copy test reports (they are gitignored but needed for GitHub Pages)
          mkdir -p deploy_temp/tests/jest/reports
          mkdir -p deploy_temp/tests/k6/reports

          # Copy Jest reports
          if [ -f tests/jest/reports/results-latest.json ]; then
            cp -v tests/jest/reports/results-latest.json deploy_temp/tests/jest/reports/
            echo "âœ“ Copied Jest results"
          else
            echo "âš  No Jest results found, creating placeholder"
            echo '{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0}' > deploy_temp/tests/jest/reports/results-latest.json
          fi

          # Copy K6 reports
          cp -v tests/k6/reports/*.json deploy_temp/tests/k6/reports/ 2>/dev/null || echo "âš  No K6 JSON reports to copy"

          # Ensure .gitignore will not exclude any report files in the publish tree
          if [ -f deploy_temp/.gitignore ]; then
            sed -i '/^tests\/jest\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/k6\/reports\/\*/d' deploy_temp/.gitignore || true
            sed -i '/^tests\/puppeteer\/reports\/\*/d' deploy_temp/.gitignore || true
            # As a safety net, remove .gitignore entirely from the publish dir
            rm -f deploy_temp/.gitignore
          fi

          # Verify test reports are included
          echo ""
          echo "=== Verifying deploy_temp contents ==="
          ls -lah deploy_temp/tests/jest/reports/ || echo "No Jest reports in deploy_temp"
          echo ""
          ls -lah deploy_temp/tests/k6/reports/ || echo "No K6 reports in deploy_temp"
          echo ""
          echo "=== Verifying Jest JSON is valid ==="
          if jq empty deploy_temp/tests/jest/reports/results-latest.json 2>/dev/null; then
            echo "âœ“ Jest JSON is valid"
            jq -r '.numTotalTests // 0' deploy_temp/tests/jest/reports/results-latest.json | xargs -I {} echo "Total tests: {}"
          else
            echo "âœ— Jest JSON is invalid"
          fi

      - name: Generate test-data.js for the dashboard
        run: |
          mkdir -p deploy_temp
          # Jest
          JEST_SRC="tests/jest/reports/results-latest.json"
          if [ -f "deploy_temp/tests/jest/reports/results-latest.json" ]; then
            JEST_SRC="deploy_temp/tests/jest/reports/results-latest.json"
          fi
          if [ -f "$JEST_SRC" ]; then
            # Validate JSON first
            if ! jq empty "$JEST_SRC" 2>/dev/null; then
              echo "âš  Invalid Jest JSON, using placeholder"
              JEST_JSON='{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0,"passRate":0,"avgDuration":0,"testSuites":[]}'
            else
              TOTAL=$(jq -r '.numTotalTests // 0' "$JEST_SRC")
              PASSED=$(jq -r '.numPassedTests // 0' "$JEST_SRC")
              FAILED=$(jq -r '.numFailedTests // 0' "$JEST_SRC")
              SUITES=$(jq -r '.numTotalTestSuites // 0' "$JEST_SRC")
              PASSED_SUITES=$(jq -r '.numPassedTestSuites // 0' "$JEST_SRC")
              SUCCESS=$([ "$FAILED" -eq 0 ] && echo true || echo false)
              if [ "$TOTAL" -gt 0 ]; then
                PASS_RATE=$(awk -v p="$PASSED" -v t="$TOTAL" 'BEGIN { printf "%.2f", (p/t)*100 }')
              else
                PASS_RATE="100.00"
              fi
              
              # Calculate total duration across all test suites (in milliseconds)
              # Handle null testResults array safely
              AVG_DURATION=$(jq -r '(.testResults // []) | map(select(. != null)) | map(.endTime - .startTime) | add // 0' "$JEST_SRC")
              
              # Extract test suites details - handle null values safely
              SUITES_DETAIL=$(jq -c '(.testResults // []) | map(select(. != null)) | map({
                name: (.name | split("/") | .[-1]),
                status: .status,
                numTests: ((.assertionResults // []) | length),
                numPassedTests: ((.assertionResults // []) | map(select(.status == "passed")) | length),
                numFailedTests: ((.assertionResults // []) | map(select(.status == "failed")) | length),
                duration: (.endTime - .startTime)
              })' "$JEST_SRC")
              
              JEST_JSON="{\"success\":$SUCCESS,\"numTotalTests\":$TOTAL,\"numPassedTests\":$PASSED,\"numFailedTests\":$FAILED,\"numTotalTestSuites\":$SUITES,\"numPassedTestSuites\":$PASSED_SUITES,\"passRate\":$PASS_RATE,\"avgDuration\":$AVG_DURATION,\"testSuites\":$SUITES_DETAIL}"
            fi
          else
            JEST_JSON='{"success":false,"numTotalTests":0,"numPassedTests":0,"numFailedTests":0,"numTotalTestSuites":0,"passRate":0,"avgDuration":0,"testSuites":[]}'
          fi

          # Coverage data from unit tests
          COVERAGE_JSON='{"lines":{"total":0,"covered":0,"pct":0},"statements":{"total":0,"covered":0,"pct":0},"functions":{"total":0,"covered":0,"pct":0},"branches":{"total":0,"covered":0,"pct":0}}'
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "âœ“ Coverage summary found in coverage/"
            COVERAGE_JSON=$(jq -c '.total' coverage/coverage-summary.json 2>/dev/null || echo "$COVERAGE_JSON")
          else
            echo "âš  No coverage summary found (run unit tests with --coverage)"
          fi

          # k6
          K6_SRC="deploy_temp/tests/k6/reports/http-summary-latest.json"
          [ ! -f "$K6_SRC" ] && K6_SRC="tests/k6/reports/http-summary-latest.json"
          if [ -f "$K6_SRC" ]; then
            K6_JSON=$(cat "$K6_SRC")
          else
            K6_JSON='{"metrics":{"http_reqs":{"count":0},"http_req_duration":{"avg":0,"p(95)":0},"checks":{"passes":0,"fails":0}}}'
          fi

          # Metadata
          BRANCH="${GITHUB_REF#refs/heads/}"
          COMMIT="${GITHUB_SHA:0:7}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Emit the payload the dashboard loads (as .js file)
          cat > deploy_temp/test-data.js <<'EOF'
          // Auto-generated test results data
          if (typeof window !== 'undefined') {
            window.TEST_RESULTS = {};
          }
          EOF
          # Append JSON safely
          {
            echo "window.TEST_RESULTS.jest = $JEST_JSON;"
            echo "window.TEST_RESULTS.k6 = $K6_JSON;"
            echo "window.TEST_RESULTS.coverage = $COVERAGE_JSON;"
            echo "window.TEST_RESULTS.metadata = {\"branch\":\"$BRANCH\",\"commit\":\"$COMMIT\",\"timestamp\":\"$TIMESTAMP\",\"triggeredBy\":\"$GITHUB_EVENT_NAME\"};"
            echo "window.TEST_RESULTS.generatedAt = '$TIMESTAMP';"
          } >> deploy_temp/test-data.js

          echo "âœ“ Emitted deploy_temp/test-data.js"
          echo "File size:"
          wc -c deploy_temp/test-data.js
          echo "First 500 chars:"
          head -c 500 deploy_temp/test-data.js

      - name: Archive test reports
        run: |
          echo "âœ“ Test reports archived successfully!"
          echo ""
          echo "ğŸ“Š Reports available in workflow artifacts:"
          echo "   - Jest reports (tests/jest/reports/)"
          echo "   - K6 reports (tests/k6/reports/)"
          echo "   - Coverage reports (coverage/)"
          echo ""
          echo "ğŸŒ Live site: https://marcelocosta.pages.dev"
          echo "   Cloudflare Pages auto-deploys on every push to main"
          echo ""
          echo "ğŸ’¡ Test data and reports are deployed to Cloudflare Pages automatically"
